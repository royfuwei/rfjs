name: Version (release/* prerelease channels)

on:
    pull_request_target:
        branches:
            - "release/*"
        types: [closed]

permissions:
    contents: write
    pull-requests: write

concurrency:
    group: version-${{ github.event.pull_request.base.ref }}
    cancel-in-progress: false

jobs:
    resolve:
        runs-on: ubuntu-latest
        outputs:
            channel: ${{ steps.ch.outputs.channel }}
        if: >
            github.event.pull_request.merged == true &&
            github.event.pull_request.head.repo.full_name == github.repository &&
            (
              github.event.pull_request.base.ref == 'release/alpha' ||
              github.event.pull_request.base.ref == 'release/beta'  ||
              github.event.pull_request.base.ref == 'release/rc'
            )
        steps:
            - name: Resolve channel from base ref
              id: ch
              shell: bash
              run: |
                  set -euo pipefail
                  REF="${{ github.event.pull_request.base.ref }}"  # e.g. release/alpha
                  CHANNEL="${REF#release/}"                        # => alpha
                  echo "channel=$CHANNEL" >> "$GITHUB_OUTPUT"
                  echo "Resolved: ref=$REF channel=$CHANNEL"

    version:
        needs: resolve
        if: needs.resolve.outputs.channel != ''
        uses: royfuwei/rf-devops/.github/workflows/_changesets-version-channel.yml@main
        secrets:
            GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
        with:
            ref: ${{ github.event.pull_request.base.ref }} # release/alpha|beta|rc
            channel: ${{ needs.resolve.outputs.channel }} # alpha|beta|rc
            node_version: 20.x
